---
title: "Demo Graficas de Torta"
author: "URSEC"
output:
  pagedown::html_paged:
    toc: false
    css:
      - "estilos/ursec-default-page.css"
      - "estilos/ursec-default.css"
      - "estilos/ursec-estilo.css"
    # change to true for a self-contained document, but it'll be a litte slower for Pandoc to render
    self_contained: true
# uncomment this line to produce HTML and PDF in RStudio:
#knit: pagedown::chrome_print
abstract: | 
  ### Informe de Mercado de Telecomunicaciones de Uruguay
  
  ### Datos a Diciembre 2020
  
  _Unidad Reguladora de Servicios de Comunicaciones (URSEC)_\
  Av. Uruguay 998 11000 Montevideo, Uruguay\
  Tel. +598 2902 8082\
  http://ursec.gub.uy
  
  
  **Presidenta**\
  Mercedes Aramendía
  
  **Vicepresidente**\
  Gustavo Delgado
  
  **Director**\
  Pablo Siris

  *División de Regulación Jurídica y Económica*\
  **Gerente**\
  Graciela Coronel\
  
  *Divisón de Servicios Postales*\
  **Gerente**\
  Luis González\

  Diseño de Portada: Enrique Ros\
  Foto de portada: Chan Lin (https://unsplash.com/@lowkeyhahaha)
  
  **Licencia**
  
  ![](estilos/cc.png)
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message=FALSE,
                      cache=FALSE,
                      fig.width = 7, 
                      fig.height = 4.5)

FECHA_INFORME_ANUAL <-  as.Date("2020-12-01")
FECHA_TITULO_STOCK <-  "Diciembre 2020"
FECHA_TITULO_FLUJO <-  "año 2020"

library(galeriaPostales)
library(tidyverse)
library(lubridate)
library(galeriaVis)
library(ggforce)

library(extrafont)
loadfonts()

theme_set(
  theme_minimal(base_family="Agency FB", base_size = 18) +
  theme(plot.background=element_rect(fill="#EEEEEE",
                                     color="white"),
          axis.line.x=element_blank(),
          axis.ticks=element_blank(),
          text=element_text(family="Agency FB")))

df <- importar_columna_trafico(c("CA", "CB", "CC")) %>% 
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal) %>% 
  summarize(numeric=round(sum(numeric)))


rpie <- 1
rlabel_out <- 1.05 * rpie
rlabel_in <- 0.6 * rpie

df_2 <- df %>% 
  arrange(numeric) %>% 
  mutate(cabezal=fct_reorder(cabezal, numeric)) %>% 
  mutate(end_angle  = 2*pi*cumsum(numeric)/sum(numeric),
         start_angle = lag(end_angle, default = 0),
         mid_angle   = 0.5*(start_angle + end_angle)) %>% 
  mutate( 
      x_lab = rlabel_in * sin(mid_angle),
      y_lab = rlabel_in * cos(mid_angle)) %>% 
  mutate(cabezal=fct_reorder(cabezal, numeric, .desc=TRUE)) %>% 
  mutate(num_format = scales::number_format(
    big.mark = ".", decimal.mark = ","
  )(numeric)) %>% 
  mutate(percent=scales::percent_format(
    scale=100
  )(numeric/sum(numeric))) %>% 
  mutate(lbl=glue::glue("{cabezal} ({percent})")) %>% 
  mutate(lbl_2=glue::glue("{cabezal}\n{num_format}")) %>% 
  mutate(lbl_3=glue::glue("{cabezal}\n{num_format}\n{percent}"))

```


<!-- ```{r} -->


<!-- df %>%  -->
<!--   pie_chart(values = numeric,  -->
<!--             labels = cabezal,  -->
<!--             nudge_x = c(5, -5, 0), -->
<!--             nudge_y = c(0, 0, 0)) %>%  -->
<!--   print() -->

<!-- ``` -->



```{r}
# Version actual barras
df %>% 
  barras_horizontales(numeric, cabezal, nudge=.125) +
  theme()

```

Ponemos los porcentajes de los menores solo en la leyenda.

```{r}
ggplot(df_2) +
  geom_arc_bar(aes(
    x0=0, y0=0, r0=0, r=1,
    amount = numeric,
    fill=lbl
  ),
  stat='pie') + 
  geom_text(
    family="Agency FB",
    size=rel(5),
    data=filter(df_2, numeric==max(numeric)),
    aes(label=lbl_2,
        x=0,
        y=-.25)
  ) +
  scale_fill_discrete("") +
  coord_fixed() +
  theme(plot.background=element_rect(fill="#EEEEEE",
                                     color="white"),
          axis.line.x=element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks=element_blank(),
          text=element_text(family="Agency FB")) 

```



```{r}
ggplot(df_2) +
  geom_arc_bar(aes(
    x0=0, y0=0, r0=0, r=rpie,
    amount = numeric,
    fill=cabezal
  ),
  stat='pie') + 
  geom_text(
    family="Agency FB",
    size=rel(5),
    data=filter(df_2),
    aes(x=x_lab + c(-.5, .5, 0), 
        y=y_lab + c(-.2, -.2, 0), 
        label=lbl_3)
  ) +
  scale_fill_discrete("") +
  coord_fixed() +
  theme(plot.background=element_rect(fill="#EEEEEE",
                                     color="white"),
          axis.line.x=element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks=element_blank(),
          text=element_text(family="Agency FB")) 
```

