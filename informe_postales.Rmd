---
title: "Informe Mercado de Servicios Postales"
author: "URSEC"
output:
  pagedown::html_paged:
    toc: true
    toc_depth: 1
    css:
      - "estilos/ursec-default-page.css"
      - "estilos/ursec-default.css"
      - "estilos/ursec-estilo.css"
    ## change to true for a self-contained document, but it'll be a litte slower for Pandoc to render
    self_contained: true
## uncomment this line to produce HTML and PDF in RStudio:
#knit: pagedown::chrome_print
abstract: | 
  #### Informe de Mercado de Telecomunicaciones de Uruguay
  
  #### Datos a Diciembre 2020
  
  _Unidad Reguladora de Servicios de Comunicaciones (URSEC)_\
  Av. Uruguay 998 11000 Montevideo, Uruguay\
  Tel. +598 2902 8082\
  http://ursec.gub.uy
  
  
  **Presidenta**\
  Mercedes Aramendía
  
  **Vicepresidente**\
  Gustavo Delgado
  
  **Director**\
  Pablo Siris

  *División de Regulación Jurídica y Económica*\
  **Gerente**\
  Graciela Coronel\
  
  *Divisón de Servicios Postales*\
  **Gerente**\
  Luis González\

  Diseño de Portada: Enrique Ros\
  Foto de portada: Chan Lin (https://unsplash.com/@lowkeyhahaha)
  
  **Licencia**
  
  ![](estilos/cc.png)
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message=FALSE,
                      cache=FALSE,
                      fig.width = 7, 
                      fig.height = 4.5)

FECHA_INFORME_ANUAL <-  as.Date("2020-12-01")
FECHA_TITULO_STOCK <-  "Diciembre 2020"
FECHA_TITULO_FLUJO <-  "año 2020"

library(galeriaPostales)
library(galeriaVis)

library(tidyverse)
library(lubridate)

theme_set(
  theme_minimal(base_family="Agency FB", base_size = 14) +
  theme(plot.background=element_rect(fill="#EEEEEE",
                                     color="white"),
          axis.line.x=element_blank(),
          axis.ticks=element_blank(),
          text=element_text(family="Agency FB")))

library(extrafont)
loadfonts()

# Helpers

flujo_semestral <- function(df) {
  df %>% 
    group_by(year=year(fecha), semester=semester(fecha)) %>%
    summarize(numeric=round(sum(numeric))) %>% 
    ungroup()
}


helper_serie <- function() {
  # Capas comunes a las series
  list(
    geom_line(),
    geom_point(), 
    scale_x_date(date_breaks= "1 months", date_labels = "%m-%y"), 
    ylim(c(0, NA)),
    labs(y="$", x="")
  )
}

serie_historica <- function(df) {
  ggplot(df, aes(fecha, numeric)) +
    helper_serie()
}

serie_historica_2 <- function(df) {
  ggplot(df, aes(fecha, numeric, color = destino)) +
    helper_serie() + 
    scale_color_discrete("") + 
    theme(legend.position = "bottom")
}

```

# Envíos Postales

### Total semestral de Cartas enviadas (en millones)

```{r}
## columnas CF y C
operadores <- importar_totales_trafico("C") %>%
  flujo_semestral() %>%
  mutate(numeric = numeric/1e6,
         operador="Operadores")

pjh <- importar_totales_trafico("CF", header_row = 3) %>%
  flujo_semestral() %>%
  mutate(numeric = numeric/1e6,
         operador="PJH")

# Este lo dejo aca pq me embola hacerlo ahora
```

### Total semestral de Paquetes enviados (en miles)
```{r}
## ED
importar_totales_trafico("ED", header_row = 3) %>%
  flujo_semestral() %>%
  mutate(numeric = numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


### Total semestral de Envíos Postales (en millones)
```{r}
## EG
importar_totales_trafico("EG", header_row = 3) %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e6) %>%
  serie_historica_semestral_flujo(numeric)

```

### Total semestral de Cartas del SPU (millones)
```{r}
## FD
importar_totales_trafico("FD") %>%
 flujo_semestral() %>%
  mutate(numeric=numeric/1e6) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes del SPU (miles)
```{r}
## FC
importar_totales_trafico("FC") %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Envíos del SPU (millones)

```{r}
## FB
importar_totales_trafico("FB") %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e6) %>%
  serie_historica_semestral_flujo(numeric)
```


### Total semestral de Cartas Nacionales (en millones)
```{r}
## H
importar_totales_trafico("CA")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e6) %>%
  serie_historica_semestral_flujo(numeric)

```


### Total semestral de Cartas Internacionales - Salida (en miles)
```{r}
## CB
importar_totales_trafico("CB")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Cartas Internacionales - Entrada (en miles)
```{r}
## CD
importar_totales_trafico("CC")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Nacionales (en miles)
```{r}
## DZ
importar_totales_trafico("DZ")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Internacionales - Salida (en miles)
```{r}
## EA
importar_totales_trafico("EA")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Internacionales - Entrada (en miles)
```{r}
## EB
importar_totales_trafico("EB")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Composición de Cartas (semestre I - 2020)
```{r}
importar_totales_trafico(c("CA", "CB", "CC")) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal) %>%
  summarize(numeric=round(sum(numeric))) %>%
  pie_chart(numeric, cabezal, nudge_x = c(-3, 3, 0)) %>%
  print()
```

### Composición de Paquetes (semestre I - 2020)
```{r}
## DZ-EB
importar_totales_trafico(c("DZ", "EA", "EB")) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal) %>%
  summarize(numeric=round(sum(numeric))) %>%
  pie_chart(numeric, cabezal, nudge_x = c(-3, 3, 0)) %>%
  print()
```

### Cartas Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("H", "W", "AL", "BA", "BP"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    barras_horizontales(numeric, cabezal_1)

```

### Cartas Internacionales – Salida (semestre I - 2020)


```{r}
importar_totales_trafico(c("BU", "BF", "AQ", "AB", "M"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    barras_horizontales(numeric, cabezal_1)
```

### Cartas Internacionales – Entrada (semestre I - 2020)
```{r}
importar_totales_trafico(c("R", "AG", "AV", "BK", "BZ"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    barras_horizontales(numeric, cabezal_1)
```

### Paquetes Nacionales (semestre I - 2020)

```{r}
## =(TRAFICO!$CR$226,TRAFICO!$DA$226,TRAFICO!$DJ$226,TRAFICO!$DS$226)

importar_totales_trafico(c("CR", "DA", "DJ", "DS"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    filter(numeric > 0) %>%
    barras_horizontales(numeric, cabezal_1)

```

### Paquetes Internacionales – Salida (semestre I - 2020)

```{r}
importar_totales_trafico(c("CL", "CU", "DD", "DM", "DV"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    barras_horizontales(numeric, cabezal_1)
```

### Paquetes Internacionales – Entrada (semestre I - 2020)
```{r}
importar_totales_trafico(c("CX", "DG", "DP", "DY"),
                         header_row = list("cabezal_1"=3, "cabezal_2"=4)) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    filter(cabezal_2=="TOTAL") %>%
    group_by(cabezal_1) %>%
    summarize(numeric=round(sum(numeric))) %>%
    barras_horizontales(numeric, cabezal_1)
```

# Cartas y Paquetes

## Cartas Comunes

### Total semestral de Cartas Comunes Nacionales (en millones)
```{r}
importar_totales_trafico("H") %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e6) %>%
  serie_historica_semestral_flujo(numeric)
```


#### Cartas Comunes Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("C", "D", "E", "F", "G"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)

```

#### Total semestral de Cartas Comunes Internacionales – Salida (en miles)
```{r}
importar_totales_trafico("M")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

#### Cartas Comunes Internacionales – Salida (semestre I - 2020)

```{r}
importar_totales_trafico(c("I", "J", "K", "L"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)

```


#### Total semestral de Cartas Comunes Internacionales – Entrada (en miles)
```{r}
importar_totales_trafico("R")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


#### Cartas Comunes Internacionales – Entrada (semestre I - 2020)
```{r}
importar_totales_trafico(c("N", "O", "P", "Q"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


## Paquetes Comunes {.page-break-before}

### Total semestral de Paquetes Comunes Nacionales (en miles)

```{r}
importar_totales_trafico("CI")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Comunes Internacionales - Salida (en miles)

```{r}
importar_totales_trafico("CL")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Comunes Internacionales - Entrada (en miles)
```{r}
importar_totales_trafico("CO")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

## Cartas Registradas {.page-break-before}

### Total semestral de Cartas Registradas Nacionales (en miles)
```{r}
importar_totales_trafico("AL")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


### Cartas Registradas Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("AH", "AI", "AJ", "AK"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Cartas Registradas Internacionales - Salida (en miles)
```{r}
importar_totales_trafico("AQ")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Cartas Registradas Internacionales - Salida (semestre I - 2020)
```{r}
importar_totales_trafico(c("AM", "AN", "AO", "AP"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Cartas Registradas Internacionales - Entrada (en miles)
```{r}
importar_totales_trafico("AV")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Cartas Registradas Internacionales - Entrada (semestre I - 2020)
```{r}
importar_totales_trafico(c("AR", "AS", "AT", "AU"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


## Paquetes Registrados {.page-break-before}

### Total semestral de Paquetes Registrados Nacionales (en miles)
```{r}
importar_totales_trafico("CR")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Paquetes Registrados Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("CP", "CQ"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Paquetes Registrados Internacionales – Salida (en miles)
```{r}
importar_totales_trafico("CU")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Paquetes Registrados Internacionales – Salida (semestre I - 2020)
```{r}
importar_totales_trafico(c("CS", "CT"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Paquetes Registrados Internacionales – Entrada (en miles)
```{r}

importar_totales_trafico("CX")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Paquetes Registrados Internacionales – Entrada (semestre I - 2020)
```{r}
importar_totales_trafico(c("CV", "CW"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


## Cartas Aseguradas {.page-break-before}

### Total semestral de Cartas Aseguradas Nacionales (en miles)
```{r}
importar_totales_trafico("BA")  %>%
  flujo_semestral() %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


### Cartas Aseguradas Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("AW", "AX", "AY", "AZ"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)

```

## Cartas Servicio Courier {.page-break-before}

### Total semestral de Cartas Courier Nacionales (en miles)
```{r}
importar_totales_trafico("BP")  %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Cartas Courier Nacionales (semestre I - 2020)
```{r}
importar_totales_trafico(c("BL", "BM", "BN", "BO"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Cartas Courier Internacionales – Salida (en miles)
```{r}
importar_totales_trafico("BU")  %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Cartas Courier Internacionales – Salida (en miles)
```{r}
importar_totales_trafico(c("BQ", "BR", "BS", "BT"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


### Total semestral de Cartas Courier Internacionales – Entrada (en miles)

```{r}
importar_totales_trafico("BZ")  %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


### Cartas Courier Internacionales – Entrada (en miles)
```{r}
importar_totales_trafico(c("BV", "BW", "BX", "BY"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


## Paquetes y Servicios Courier {.page-break-before}

### Total semestral de Paquetes Courier Nacionales (en miles)
```{r}
importar_totales_trafico("DS")  %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Total semestral de Paquetes Courier Nacionales (en miles)
```{r}
importar_totales_trafico(c("DQ", "DR"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```


### Total semestral de Paquetes Courier Internacionales – Salida (en miles)
```{r}
importar_totales_trafico("DV")  %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```

### Paquetes Courier Internacionales – Salida (en miles)
```{r}
importar_totales_trafico(c("DT", "DU"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```

### Total semestral de Paquetes Courier Internacionales – Entrada (en miles)
```{r}
importar_totales_trafico("DY") %>%
  flujo_semestral() %>%
  filter(year>= 2016) %>%
  mutate(numeric=numeric/1e3) %>%
  serie_historica_semestral_flujo(numeric)
```


### Paquetes Courier Internacionales – Entrada (en miles)
```{r}
importar_totales_trafico(c("DW", "DX"),
                         header_row=list(cabezal_1=4)) %>%
  filter(year(fecha)==2020, semester(fecha)==1) %>%
  group_by(cabezal_1) %>%
  summarize(numeric=round(sum(numeric))) %>%
  barras_horizontales(numeric, cabezal_1)
```



## Envíos por Operador {.page-break-before}

### Cartas por operador (semestre I - 2020)
```{r}
cartas_base_larga <- readRDS(here::here("data", "cartas_base_larga.rds"))

# Colapsar chicos
cartas_base_larga %>%
    #filter(stringr::str_detect(header_1, "[Nn]ac")) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(numeric) %>%
    barras_horizontales(numeric, nombre)
```

### Paquetes por operador (semestre I - 2020)

```{r}
paquetes_base_larga <- readRDS(here::here("data", "paquetes_base_larga.rds"))

paquetes_base_larga %>%
   # filter(stringr::str_detect(header_1, "[Nn]ac")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)

```

### Cartas Nacionales por operador (semestre I - 2020)

```{r}

# Colapsar chicos
cartas_base_larga %>%
    filter(stringr::str_detect(header_1, "[Nn]ac")) %>%
    filter(year(fecha)==2020, semester(fecha)==1) %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)

```


### Paquetes Nacionales por operador (semestre I - 2020)

```{r}
paquetes_base_larga %>%
    filter(stringr::str_detect(header_1, "[Nn]ac")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)


```

### Cartas Internacionales – Salida - por operador (semestre I - 2020)
```{r}
cartas_base_larga %>%
    filter(stringr::str_detect(header_1, "[Ss]al")) %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```


### Paquetes Internacionales – Salida - por operador (semestre I - 2020)

```{r}
paquetes_base_larga %>%
    filter(stringr::str_detect(header_1, "[Ss]al")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)

```

### Cartas Internacionales – Entrada - por operador (semestre I - 2020)
```{r}
cartas_base_larga %>%
    filter(stringr::str_detect(header_1, "[Ee]nt")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```


### Paquetes Internacionales – Entrada - por operador (semestre I - 2020)
```{r}
paquetes_base_larga %>%
    filter(stringr::str_detect(header_1, "[Ee]nt")) %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```


### Cartas Courier Nacionales por operador (semestre I - 2020)
```{r}
cartas_base_larga %>%
    filter(header_1 == "Courier Nac - Hasta 20 g") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```



### Paquetes Courier Nacionales por operador (semestre I - 2020)
```{r}
paquetes_base_larga %>%
    filter(header_1 == "Courier Nac") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```


### Cartas Courier Internacionales – Salida - por operador (semestre I - 2020)
```{r}
cartas_base_larga %>%
    filter(header_1 == "Courier Sal - Hasta 20 g") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```

### Paquetes Courier Internacionales – Salida - por operador (semestre I - 2020)
```{r}
paquetes_base_larga %>%
    filter(header_1 == "Courier Sal") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```

### Cartas Courier Internacionales – Entrada - por operador (semestre I - 2020)
```{r}
cartas_base_larga %>%
    filter(header_1 == "Courier Ent - Hasta 20 g") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```

### Paquetes Courier Internacionales – Entrada - por operador (semestre I - 2020)
```{r}
paquetes_base_larga %>%
    filter(header_1 == "Courier Ent") %>%
    filter(year(fecha)==2020, semester(fecha)==1)  %>%
    mutate(nombre = fct_lump_n(nombre, n = 10, w=numeric, other_level = "Otros")) %>%
    group_by(nombre) %>%
    summarize(numeric=sum(numeric)) %>%
    arrange(-numeric) %>%
    barras_horizontales(numeric, nombre)
```


# Tarifas de Cartas


```{r}

# Pattern para parsear la columna header_1
PAT_INTERNACIONALES <- "(Internacionales) \\((.*)\\) (.*)$"
PAT_NACIONALES <- "(Nacionales) (.*)$"

tarifas_historico <- importar_totales_tarifas() %>%
  mutate(nacionales = if_else(str_detect(header_1, "Nacionales"),
                              "Nacionales",
                              "Internacionales")) %>%
  mutate(tipo = if_else(nacionales == "Nacionales",
                        str_match(header_1, PAT_NACIONALES)[,3],
                        str_match(header_1, PAT_INTERNACIONALES)[,4])) %>%
  mutate(destino = if_else(nacionales == "Internacionales",
                           str_match(header_1, PAT_INTERNACIONALES)[,3],
                           NA_character_))

```

### Tarifas promedio Cartas Comunes de 20 grs. – Nacional (pesos con impuestos)



```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()

```

### Tarifas promedio Cartas Comunes de 20 grs. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas Comunes de 100 grs. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```

### Tarifas promedio Cartas Comunes de 100 grs. - Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas Comunes de 500 grs. – Nacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "500 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```

### Tarifas promedio Cartas Comunes de 500 grs. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Comunes") %>%
  filter(header_2 == "500 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas Registradas de 20 grs. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio Cartas Registradas de 20 grs. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas Registradas de 100 grs. – Nacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio Cartas Registradas de 100 grs. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "100 grs")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```



### Tarifas promedio Cartas Registradas de 500 grs. – Nacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "500 grs")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio Cartas Registradas de 500 grs. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Registradas") %>%
  filter(header_2 == "500 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas servicio Courier de 20 grs. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio Cartas servicio Courier de 20 grs. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "20 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio Cartas servicio Courier de 100 grs. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```




### Tarifas promedio Cartas servicio Courier de 100 grs. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
  
```


### Tarifas promedio Cartas servicio Courier de 500 grs. – Nacional    (pesos con impuestos)


```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "100 grs") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```



### Tarifas promedio Cartas servicio Courier de 500 grs. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Cartas") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2 == "500 grs")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


# Tarifas de Paquetes

### Tarifas promedio de Paquetes Registrados de 2 kg. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Registrados") %>%
  filter(header_2=="2 kg")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()


```


### Tarifas promedio de Paquetes Registrados de 2 kg. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Registrados") %>%
  filter(header_2=="2 kg")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio de Paquetes Registrados de 5 kg. – Nacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Registrados") %>%
  filter(header_2=="5 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes Registrados de 5 kg. – Internacional (pesos con impuestos)

```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Registrados") %>%
  filter(header_2=="5 kg")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio de Paquetes servicio Asegurados de 2 kg.– Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Asegurados") %>%
  filter(header_2=="5 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Asegurados de 5 kg.– Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Asegurados") %>%
  filter(header_2=="5 kg")  %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Contra Reembolso de 2 kg.– Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Contra reembolso") %>%
  filter(header_2=="2 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Contra Reembolso de 5 kg.– Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Contra reembolso") %>%
  filter(header_2=="5 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Courier de 2 kg.– Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2=="2 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Courier de 2 kg. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2=="2 kg")%>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


### Tarifas promedio de Paquetes servicio Courier de 5kg. – Nacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Nacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2=="5 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica()
```


### Tarifas promedio de Paquetes servicio Courier de 5 kg. – Internacional (pesos con impuestos)
```{r}
tarifas_historico %>%
  filter(header_0 == "Paquetes") %>%
  filter(nacionales=="Internacionales") %>%
  filter(tipo == "Courier") %>%
  filter(header_2=="5 kg") %>%
  mutate(fecha=as.Date(fecha)) %>%
  serie_historica_2()
```


# Servicios Financieros
```{r}
giros_base_larga <- readRDS(here::here("data", "giros_base_larga.rds"))

```

### Total semestral de giros postales (miles)
```{r}
giros_base_larga %>%
  filter(header_1 %in% c("Giros int ent", "Giros int sal", "Giros nac")) %>%
  group_by(year=year(fecha), semester=semester(fecha)) %>%
  summarize(numeric = sum(numeric) / 1e3) %>%
  serie_historica_semestral_flujo(numeric)

```


### Giros postales nacionales por operador (semestre I - 2020)
```{r}
giros_base_larga %>%
  filter(header_1 %in% c("Giros nac")) %>%
  filter(year(fecha) == 2020, semester(fecha) == 1) %>%
  group_by(nombre) %>%
  summarize(numeric = sum(numeric)) %>%
  arrange(numeric) %>%
  filter(numeric > 0) %>%
  barras_horizontales(numeric, nombre)
```


### Giros postales Internacionales – Salida por operador (semestre I - 2020)
```{r}
giros_base_larga %>%
  filter(header_1 %in% c("Giros int sal")) %>%
  filter(year(fecha) == 2020, semester(fecha) == 1) %>%
  group_by(nombre) %>%
  summarize(numeric = sum(numeric)) %>%
  arrange(numeric) %>%
  filter(numeric > 0) %>%
  barras_horizontales(numeric, nombre)
```


### Giros postales Internacionales – Entrada por operador (semestre I - 2020)
```{r}
giros_base_larga %>%
  filter(header_1 %in% c("Giros int ent")) %>%
  filter(year(fecha) == 2020, semester(fecha) == 1) %>%
  group_by(nombre) %>%
  summarize(numeric = sum(numeric)) %>%
  arrange(numeric) %>%
  filter(numeric > 0)  %>%
  barras_horizontales(numeric, nombre)
```



# Dimensión

### Oficinas Postales abiertas al público por tipo (semestre I – 2020)

```{r}
dimension <- readRDS(here::here("data", "dimension_base_larga.rds"))

```


```{r}

dimension %>%
  filter(year(fecha) == 2020, month(fecha) == 6) %>%
  group_by(header_1) %>%
  summarize(numeric = sum(numeric)) %>%
  filter(header_1 %in% c("Of financ", "Of móviles",
                         "Of perm pro", "Of perm ext")) %>%
  barras_horizontales(numeric, header_1)

```


### Oficinas Postales no abiertas al público por tipo (semestre I – 2020)
```{r}
dimension %>%
  filter(year(fecha) == 2020, month(fecha) == 6) %>%
  group_by(header_1) %>%
  summarize(numeric = sum(numeric)) %>%
  filter(header_1 %in% c("Of clasif", "Of interc")) %>%
  barras_horizontales(numeric, header_1)

```


# Envíos Por habitante

### Total semestral de envíos por habitante
```{r}

paquetes_totales <- paquetes_base_larga %>%
  group_by(year=year(fecha)) %>%
  summarize(paquetes = sum(numeric))

cartas_totales <- cartas_base_larga %>%
  group_by(year=year(fecha)) %>%
  summarize(cartas = sum(numeric))



poblacion <- tibble(
  year = 1999:2020,
  pob= c(3335615,	3349155,	3351491,	3346677,
         3338399,	3341417,	3352355,	3358005,
         3358794,	3363060,	3378083,	3396706,
         3412636,	3426466,	3440157,	3453691,
         3467054,	3480222,  3493205,	3505985,
         3518552,	3530912))

envios_pre <- tibble(
  year=1999:2013,
  envios_pob = c(11.94,	13.54,	12.60,
                 12.71,	13.13,	12.75,
                 12.51,	13.14,	14.50,
                 16.13,	17.75,	19.54,
                 24.82,	24.63,	34.55))

envios_post <- paquetes_totales %>%
  filter(year>2013) %>%
  left_join(cartas_totales, by="year") %>%
  left_join(poblacion, by="year") %>%
  mutate(envios = paquetes + cartas) %>%
  mutate(envios_pob = (paquetes+cartas) / pob) %>%
  select(year, envios_pob)

envios <- bind_rows(envios_pre, envios_post)

envios %>%
  ggplot(aes(year, envios_pob)) +
  geom_line() +
  geom_point()


```


# Ingresos del Sector

### Facturación semestral del Sector Postal (millones de pesos corrientes)
```{r}

```


# Activo Fijo

### Inversión Neta (semestre I - 2020)